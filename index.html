<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Split the G</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IM+Fell+English+SC&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        html, body {
            height: 100%;
            overflow: hidden;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }

        body {
            background: #0d0d0d;
            color: #e0d6c2;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        /* ════════════════════════════════════════
           SCREENS
           ════════════════════════════════════════ */
        .screen {
            position: fixed;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px 24px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease;
        }
        .screen.active {
            opacity: 1;
            pointer-events: auto;
        }

        /* VERSION FOOTER */
        .version {
            position: fixed;
            bottom: 6px;
            right: 10px;
            font-size: 0.6rem;
            color: #3a3228;
            z-index: 100;
            pointer-events: none;
        }

        /* ════════════════════════════════════════
           START SCREEN
           ════════════════════════════════════════ */
        .title {
            font-family: 'IM Fell English SC', serif;
            font-size: 2.5rem;
            font-weight: 400;
            color: #c8a84e;
            letter-spacing: 0.04em;
        }
        .subtitle {
            font-size: 0.8rem;
            color: #7a6a4a;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            margin-bottom: 40px;
        }
        .instructions {
            line-height: 2.2;
            font-size: 0.95rem;
            color: #a09080;
            margin-bottom: 40px;
            text-align: left;
        }
        .instructions span {
            color: #c8a84e;
            font-weight: 700;
        }
        .sensor-info {
            margin-top: 24px;
            font-size: 0.7rem;
            color: #706850;
            text-align: center;
            min-height: 2.5em;
            white-space: pre-line;
        }

        /* ════════════════════════════════════════
           BUTTONS
           ════════════════════════════════════════ */
        .btn {
            padding: 16px 52px;
            font-size: 1.05rem;
            font-weight: 700;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            letter-spacing: 0.1em;
            transition: transform 0.1s;
            -webkit-tap-highlight-color: transparent;
        }
        .btn:active { transform: scale(0.95); }
        .btn:disabled { opacity: 0.5; }

        .btn-primary {
            background: linear-gradient(135deg, #d4b050, #a08030);
            color: #1a1408;
            box-shadow: 0 4px 24px rgba(200, 168, 78, 0.25);
        }
        .btn-stop {
            background: transparent;
            border: 2px solid rgba(200, 168, 78, 0.5);
            color: #c8a84e;
            padding: 14px 44px;
            font-size: 0.95rem;
        }

        /* ════════════════════════════════════════
           GAME SCREEN
           ════════════════════════════════════════ */
        #screen-game {
            justify-content: flex-start;
            padding-top: 20px;
            padding-bottom: 30px;
        }

        .hud {
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 24px;
            font-size: 0.8rem;
            color: #7a6a4a;
            font-variant-numeric: tabular-nums;
            margin-bottom: 4px;
            flex-shrink: 0;
        }
        .hud-val { color: #c8a84e; font-weight: 600; }

        .debug {
            width: 100%;
            padding: 6px 12px;
            background: rgba(200,168,78,0.06);
            border-radius: 6px;
            font-size: 0.65rem;
            color: #8a7a5a;
            font-family: monospace;
            line-height: 1.6;
            text-align: center;
            margin-bottom: 4px;
            flex-shrink: 0;
        }

        .pour-indicator {
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 0.25em;
            color: #c8a84e;
            height: 18px;
            opacity: 0;
            transition: opacity 0.15s;
            flex-shrink: 0;
        }
        .pour-indicator.visible { opacity: 1; }

        .glass-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            width: 100%;
            min-height: 0;
        }

        /* ─── THE PINT GLASS (Guinness gravity glass) ─── */
        .glass-wrap {
            position: relative;
            width: 150px;
            height: 320px;
        }

        /* SVG outline sits on top of everything */
        .glass-svg {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            z-index: 15;
            pointer-events: none;
        }
        .glass-path {
            fill: rgba(255,255,255,0.02);
            stroke: rgba(255,255,255,0.18);
            stroke-width: 2;
            stroke-linejoin: round;
        }

        /* Glass interior — clipped to pint shape */
        .glass {
            position: absolute;
            inset: 0;
            overflow: hidden;
            /*
             * Guinness gravity glass: wide rim, S-curve waist
             * at ~35% from bottom, gentle belly, sturdy base.
             */
            clip-path: polygon(
                3.3% 0.6%, 96.7% 0.6%,
                96.0% 6.3%, 95.0% 12.5%, 93.3% 18.8%, 91.3% 25.0%,
                89.0% 31.3%, 86.3% 37.5%, 83.3% 43.8%, 81.0% 50.0%,
                79.7% 56.3%, 78.7% 62.5%, 78.0% 65.6%,
                78.3% 68.8%, 79.3% 73.4%, 80.7% 78.1%,
                79.7% 82.8%, 78.3% 87.5%, 76.3% 92.2%,
                74.7% 96.9%, 74.0% 98.8%,
                73.3% 100%, 50% 100%, 26.7% 100%,
                26.0% 98.8%, 25.3% 96.9%, 23.7% 92.2%,
                21.7% 87.5%, 20.3% 82.8%, 19.3% 78.1%,
                20.7% 73.4%, 21.7% 68.8%, 22.0% 65.6%,
                21.3% 62.5%, 20.3% 56.3%, 19.0% 50.0%,
                16.7% 43.8%, 13.7% 37.5%, 11.0% 31.3%,
                8.7% 25.0%, 6.7% 18.8%, 5.0% 12.5%, 4.0% 6.3%
            );
        }

        /* Glass shine / reflection — clipped with the glass */
        .glass::after {
            content: '';
            position: absolute;
            top: 0;
            left: 14%;
            width: 12%;
            height: 100%;
            background: linear-gradient(180deg,
                rgba(255,255,255,0.08) 0%,
                rgba(255,255,255,0.03) 50%,
                transparent 80%
            );
            pointer-events: none;
            z-index: 20;
        }

        /* ─── LIQUID ─── */
        .liquid {
            position: absolute;
            bottom: -60px;
            left: -50%;
            width: 200%;
            background: #1a1a1a;
            transform-origin: center center;
            z-index: 1;
            will-change: transform, height;
        }

        /* Foam head */
        .foam {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(180deg,
                #f5edd6 0%,
                #ede1c8 20%,
                #ddd0b0 45%,
                #8a7a58 75%,
                #1a1a1a 100%
            );
            z-index: 2;
        }

        /* Carbonation texture */
        .liquid::after {
            content: '';
            position: absolute;
            top: 30px;
            left: 25%;
            width: 50%;
            height: calc(100% - 30px);
            background: radial-gradient(
                ellipse 1px 1px at 20% 30%, rgba(255,255,255,0.04) 50%, transparent 50%
            ),
            radial-gradient(
                ellipse 1px 1px at 60% 50%, rgba(255,255,255,0.03) 50%, transparent 50%
            ),
            radial-gradient(
                ellipse 1px 1px at 40% 70%, rgba(255,255,255,0.04) 50%, transparent 50%
            );
            pointer-events: none;
        }

        /* ─── "SPLIT THE G" TEXT (replaces gold line) ─── */
        .g-text {
            position: absolute;
            bottom: 60%;
            left: 0;
            right: 0;
            text-align: center;
            font-family: 'IM Fell English SC', serif;
            color: rgba(200, 168, 78, 0.55);
            z-index: 25;
            pointer-events: none;
            line-height: 1;
            text-shadow:
                0 0 12px rgba(200, 168, 78, 0.15),
                0 1px 3px rgba(0, 0, 0, 0.6);
        }
        .g-line1 {
            display: block;
            font-size: 13px;
            letter-spacing: 0.15em;
            margin-bottom: 2px;
        }
        .g-letter {
            display: block;
            font-size: 54px;
            line-height: 0.8;
        }

        /* ════════════════════════════════════════
           SCORE SCREEN
           ════════════════════════════════════════ */
        .score-title {
            font-family: 'IM Fell English SC', serif;
            font-size: 2rem;
            font-weight: 400;
            color: #c8a84e;
            margin-bottom: 8px;
            text-align: center;
        }
        .score-subtitle {
            font-size: 0.85rem;
            color: #7a6a4a;
            margin-bottom: 36px;
        }

        .score-details {
            width: 100%;
            max-width: 260px;
            margin-bottom: 12px;
        }
        .score-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(200,168,78,0.12);
            font-size: 0.95rem;
            color: #a09080;
        }
        .score-row:last-child { border-bottom: none; }
        .score-row.highlight {
            color: #c8a84e;
            font-weight: 700;
            font-size: 1.1rem;
        }
        .score-row span:last-child { font-variant-numeric: tabular-nums; }

        .accuracy-bar {
            width: 100%;
            max-width: 260px;
            height: 6px;
            background: rgba(255,255,255,0.08);
            border-radius: 3px;
            margin-bottom: 40px;
            overflow: hidden;
        }
        .accuracy-fill {
            height: 100%;
            width: 0%;
            border-radius: 3px;
            transition: width 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .accuracy-fill.gold { background: #c8a84e; }
        .accuracy-fill.green { background: #4ea84e; }
        .accuracy-fill.red { background: #a84e4e; }

        /* ════════════════════════════════════════
           MINI GLASS (Score screen)
           ════════════════════════════════════════ */
        .mini-glass-wrap {
            position: relative;
            width: 60px;
            height: 130px;
            margin-bottom: 30px;
        }
        .mini-glass {
            position: absolute;
            inset: 0;
            overflow: hidden;
            background: rgba(255,255,255,0.02);
            clip-path: polygon(
                3.3% 0.6%, 96.7% 0.6%,
                96.0% 6.3%, 95.0% 12.5%, 93.3% 18.8%, 91.3% 25.0%,
                89.0% 31.3%, 86.3% 37.5%, 83.3% 43.8%, 81.0% 50.0%,
                79.7% 56.3%, 78.7% 62.5%, 78.0% 65.6%,
                78.3% 68.8%, 79.3% 73.4%, 80.7% 78.1%,
                79.7% 82.8%, 78.3% 87.5%, 76.3% 92.2%,
                74.7% 96.9%, 74.0% 98.8%,
                73.3% 100%, 50% 100%, 26.7% 100%,
                26.0% 98.8%, 25.3% 96.9%, 23.7% 92.2%,
                21.7% 87.5%, 20.3% 82.8%, 19.3% 78.1%,
                20.7% 73.4%, 21.7% 68.8%, 22.0% 65.6%,
                21.3% 62.5%, 20.3% 56.3%, 19.0% 50.0%,
                16.7% 43.8%, 13.7% 37.5%, 11.0% 31.3%,
                8.7% 25.0%, 6.7% 18.8%, 5.0% 12.5%, 4.0% 6.3%
            );
        }
        .mini-glass-svg {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
        }
        .mini-glass-path {
            fill: none;
            stroke: rgba(255,255,255,0.15);
            stroke-width: 2;
            stroke-linejoin: round;
        }
        .mini-liquid {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #1a1a1a;
            transition: height 0.6s ease;
        }
        .mini-foam {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 10px;
            background: linear-gradient(180deg, #f5edd6, #1a1a1a);
        }
        .mini-g-text {
            position: absolute;
            bottom: 60%;
            left: 0;
            right: 0;
            text-align: center;
            font-family: 'IM Fell English SC', serif;
            font-size: 16px;
            color: rgba(200,168,78,0.4);
            z-index: 15;
            pointer-events: none;
            line-height: 0.85;
        }
    </style>
</head>
<body>

    <div class="version">v0.7</div>

    <!-- ═══════════════════════════════════════════
         START SCREEN
         ═══════════════════════════════════════════ -->
    <div id="screen-start" class="screen active">
        <h1 class="title">Split the G</h1>
        <div class="subtitle">The Pint Challenge</div>
        <div class="instructions">
            <p><span>1.</span> Hold your phone upright like a pint</p>
            <p><span>2.</span> Tap START, then tilt to "drink"</p>
            <p><span>3.</span> Return upright at the G</p>
            <p style="font-size:0.75rem;color:#605848;margin-top:8px">No tilt? Check Chrome > Site Settings > Motion sensors.</p>
        </div>
        <button id="btn-start" class="btn btn-primary">START</button>
        <div class="sensor-info" id="sensor-info">Tap START to begin.</div>
    </div>

    <!-- ═══════════════════════════════════════════
         GAME SCREEN
         ═══════════════════════════════════════════ -->
    <div id="screen-game" class="screen">
        <div class="hud">
            <div>Tilt: <span class="hud-val" id="hud-tilt">0</span>&deg;</div>
            <div>Level: <span class="hud-val" id="hud-level">100.0</span>%</div>
        </div>
        <div class="debug" id="debug">sensor: — | beta: — | init: — | events: 0</div>
        <div class="pour-indicator" id="pour-ind">POURING</div>
        <div class="glass-area">
            <div class="glass-wrap">
                <!-- SVG glass outline -->
                <svg class="glass-svg" viewBox="0 0 150 320">
                    <path class="glass-path" d="M 5,2 L 145,2 C 143,80 132,150 117,210 C 115,225 119,242 121,252 C 122,262 117,295 111,316 Q 95,320 75,320 Q 55,320 39,316 C 33,295 28,262 29,252 C 31,242 35,225 33,210 C 18,150 7,80 5,2 Z"/>
                </svg>
                <!-- Clipped interior -->
                <div class="glass">
                    <div id="liquid" class="liquid">
                        <div id="foam" class="foam"></div>
                    </div>
                </div>
                <!-- "Split the G" etched on the glass -->
                <div class="g-text">
                    <span class="g-line1">Split the</span>
                    <span class="g-letter">G</span>
                </div>
            </div>
        </div>
        <button id="btn-stop" class="btn btn-stop">DONE</button>
    </div>

    <!-- ═══════════════════════════════════════════
         SCORE SCREEN
         ═══════════════════════════════════════════ -->
    <div id="screen-score" class="screen">
        <h2 id="score-title" class="score-title"></h2>
        <div id="score-subtitle" class="score-subtitle"></div>
        <div class="mini-glass-wrap">
            <svg class="mini-glass-svg" viewBox="0 0 60 130">
                <path class="mini-glass-path" d="M 2,0.8 L 58,0.8 C 57.2,32.5 52.8,60.9 46.8,85.3 C 46,91.4 47.6,98.3 48.4,102.4 C 48.8,106.5 46.8,119.8 44.4,128.4 Q 38,130 30,130 Q 22,130 15.6,128.4 C 13.2,119.8 11.2,106.5 11.6,102.4 C 12.4,98.3 14,91.4 13.2,85.3 C 7.2,60.9 2.8,32.5 2,0.8 Z"/>
            </svg>
            <div class="mini-glass">
                <div id="mini-liquid" class="mini-liquid">
                    <div class="mini-foam"></div>
                </div>
            </div>
            <div class="mini-g-text">G</div>
        </div>
        <div class="score-details">
            <div class="score-row">
                <span>Your level</span>
                <span id="s-level">—</span>
            </div>
            <div class="score-row">
                <span>Target</span>
                <span>60.0%</span>
            </div>
            <div class="score-row highlight">
                <span>Accuracy</span>
                <span id="s-accuracy">—</span>
            </div>
        </div>
        <div class="accuracy-bar">
            <div id="acc-fill" class="accuracy-fill gold"></div>
        </div>
        <button id="btn-retry" class="btn btn-primary">TRY AGAIN</button>
    </div>

    <script>
    (() => {
        'use strict';

        const VERSION = 'v0.7';

        /* ════════════════════════════════════════════════════════
         * PHYSICS CONSTANTS — Tweak these to change the "feel"
         * ════════════════════════════════════════════════════════
         *
         * SPRING-DAMPER MODEL (Simple Harmonic Motion)
         * ────────────────────────────────────────────
         *   acceleration = SPRING_K * (target - current) - DAMPING_C * velocity
         *
         *   Natural frequency:  w0 = sqrt(K)   ≈ 12.2 rad/s (~2 Hz)
         *   Damping ratio:      z  = C/(2*w0)  ≈ 0.74  (slightly underdamped)
         *
         * TO MAKE IT HEAVIER:  decrease K    TO MAKE IT WOBBLIER: decrease C
         * TO MAKE IT SNAPPIER: increase K    TO KILL WOBBLE:      increase C past ~24.5
         */
        const SPRING_K  = 150;
        const DAMPING_C = 18;

        /* POURING BEHAVIOUR */
        const POUR_THRESHOLD = 15;
        const MAX_POUR_RATE  = 8;
        const MAX_TILT       = 70;

        /* VISUAL LIMITS */
        const MAX_SURFACE_ANGLE = 15;
        const FOAM_HEIGHT_MAX   = 28;
        const GLASS_HEIGHT      = 320;
        const LIQUID_BOTTOM_PAD = 60;

        /* GAME RULES */
        const TARGET_LEVEL     = 60;
        const SETTLE_THRESHOLD = 8;
        const SETTLE_TIME      = 1.0;

        /* ════════════════════════════════════════════════════════
         * STATE
         * ════════════════════════════════════════════════════════ */
        let state          = 'idle';
        let initialBeta    = 90;
        let currentBeta    = 90;

        let liquidLevel    = 100;
        let surfaceAngle   = 0;
        let surfaceVel     = 0;

        let hasPouredAny   = false;
        let uprightTimer   = 0;
        let lastTime       = 0;
        let rafId          = null;

        /* ════════════════════════════════════════════════════════
         * DOM REFERENCES
         * ════════════════════════════════════════════════════════ */
        const $ = (id) => document.getElementById(id);

        const screens = {
            start: $('screen-start'),
            game:  $('screen-game'),
            score: $('screen-score'),
        };

        const dom = {
            btnStart:   $('btn-start'),
            btnStop:    $('btn-stop'),
            btnRetry:   $('btn-retry'),
            liquid:     $('liquid'),
            foam:       $('foam'),
            hudTilt:    $('hud-tilt'),
            hudLevel:   $('hud-level'),
            debug:      $('debug'),
            pourInd:    $('pour-ind'),
            sensorInfo: $('sensor-info'),
            scoreTitle: $('score-title'),
            scoreSub:   $('score-subtitle'),
            sLevel:     $('s-level'),
            sAccuracy:  $('s-accuracy'),
            accFill:    $('acc-fill'),
            miniLiquid: $('mini-liquid'),
        };

        /* ════════════════════════════════════════════════════════
         * SENSOR HANDLING
         * ════════════════════════════════════════════════════════
         *
         * Strategy (in order):
         *   1. DeviceOrientationEvent
         *   2. DeviceMotionEvent (accelerometer)
         *   3. Generic Sensor API (GravitySensor / Accelerometer)
         *   4. Touch/mouse drag fallback
         */

        let sensorMode      = 'none';
        let gotSensorReading = false;
        let sensorEventCount = 0;
        let triedApis        = [];

        function onOrientation(e) {
            if (e.beta !== null) {
                currentBeta = e.beta;
                gotSensorReading = true;
                sensorEventCount++;
            }
        }

        function onDeviceMotion(e) {
            const g = e.accelerationIncludingGravity;
            if (g && g.y !== null && g.z !== null) {
                currentBeta = Math.atan2(g.y, g.z) * (180 / Math.PI);
                gotSensorReading = true;
                sensorEventCount++;
            }
        }

        async function initSensors() {
            if (sensorMode !== 'none') return true;

            if (typeof DeviceOrientationEvent !== 'undefined' &&
                typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const perm = await DeviceOrientationEvent.requestPermission();
                    if (perm !== 'granted') {
                        enableTouchFallback('Motion permission denied — drag up/down to tilt.');
                        return true;
                    }
                } catch (err) {
                    enableTouchFallback('Permission error — drag up/down to tilt.');
                    return true;
                }
            }

            if ('DeviceOrientationEvent' in window) {
                triedApis.push('orientation');
                gotSensorReading = false;
                sensorEventCount = 0;
                window.addEventListener('deviceorientation', onOrientation);
                dom.sensorInfo.textContent = 'Trying orientation sensor...';
                await sleep(600);
                if (gotSensorReading) {
                    sensorMode = 'orientation';
                    dom.sensorInfo.textContent = 'Gyro active.';
                    return true;
                }
                window.removeEventListener('deviceorientation', onOrientation);
            }

            if ('DeviceMotionEvent' in window) {
                triedApis.push('motion');
                gotSensorReading = false;
                sensorEventCount = 0;
                window.addEventListener('devicemotion', onDeviceMotion);
                dom.sensorInfo.textContent = 'Trying motion sensor...';
                await sleep(600);
                if (gotSensorReading) {
                    sensorMode = 'motion';
                    dom.sensorInfo.textContent = 'Accelerometer active.';
                    return true;
                }
                window.removeEventListener('devicemotion', onDeviceMotion);
            }

            const genericOk = await tryGenericSensor();
            if (genericOk) return true;

            enableTouchFallback('Sensors blocked by browser. Drag up/down to play.\nTo enable tilt: Chrome > Settings > Site Settings > Motion sensors.');
            return true;
        }

        async function tryGenericSensor() {
            const sensorClasses = [];
            if (typeof GravitySensor !== 'undefined') sensorClasses.push(GravitySensor);
            if (typeof Accelerometer !== 'undefined') sensorClasses.push(Accelerometer);

            for (const SensorClass of sensorClasses) {
                try {
                    triedApis.push(SensorClass.name);
                    gotSensorReading = false;
                    sensorEventCount = 0;
                    const sensor = new SensorClass({ frequency: 60 });
                    sensor.addEventListener('reading', () => {
                        if (sensor.y !== null && sensor.z !== null) {
                            currentBeta = Math.atan2(sensor.y, sensor.z) * (180 / Math.PI);
                            gotSensorReading = true;
                            sensorEventCount++;
                        }
                    });
                    sensor.addEventListener('error', () => {});
                    sensor.start();
                    dom.sensorInfo.textContent = 'Trying ' + SensorClass.name + '...';
                    await sleep(600);
                    if (gotSensorReading) {
                        sensorMode = 'generic';
                        dom.sensorInfo.textContent = SensorClass.name + ' active.';
                        return true;
                    }
                    sensor.stop();
                } catch (e) {}
            }
            return false;
        }

        function enableTouchFallback(msg) {
            if (sensorMode === 'touch') return;
            sensorMode = 'touch';
            dom.sensorInfo.textContent = msg;
            const update = (clientY) => {
                const norm = 1 - (clientY / window.innerHeight);
                currentBeta = 90 - norm * 70;
                sensorEventCount++;
            };
            document.addEventListener('mousemove', (e) => update(e.clientY));
            document.addEventListener('touchmove', (e) => {
                update(e.touches[0].clientY);
            }, { passive: true });
        }

        /* ════════════════════════════════════════════════════════
         * GAME LIFECYCLE
         * ════════════════════════════════════════════════════════ */

        async function startGame() {
            dom.btnStart.disabled = true;
            dom.btnStart.textContent = 'CONNECTING...';
            await initSensors();
            dom.btnStart.disabled = false;
            dom.btnStart.textContent = 'START';

            initialBeta = currentBeta;

            liquidLevel  = 100;
            surfaceAngle = 0;
            surfaceVel   = 0;
            hasPouredAny = false;
            uprightTimer = 0;

            state = 'playing';
            showScreen('game');
            render(false);
            requestWakeLock();

            lastTime = performance.now();
            rafId = requestAnimationFrame(tick);
        }

        function tick(now) {
            if (state !== 'playing') return;

            const dt = Math.min((now - lastTime) / 1000, 0.05);
            lastTime = now;

            const rawTilt  = currentBeta - initialBeta;
            const tilt     = clamp(Math.abs(rawTilt), 0, MAX_TILT);
            const tiltSign = rawTilt >= 0 ? 1 : -1;

            const target       = tiltSign * (tilt / MAX_TILT) * MAX_SURFACE_ANGLE;
            const springForce  =  SPRING_K * (target - surfaceAngle);
            const dampingForce = -DAMPING_C * surfaceVel;
            const accel        = springForce + dampingForce;

            surfaceVel   += accel * dt;
            surfaceAngle += surfaceVel * dt;

            let isPouring = false;
            if (tilt > POUR_THRESHOLD && liquidLevel > 0) {
                isPouring = true;
                hasPouredAny = true;
                const pourFraction = (tilt - POUR_THRESHOLD) / (MAX_TILT - POUR_THRESHOLD);
                const rate = MAX_POUR_RATE * clamp(pourFraction, 0, 1);
                liquidLevel = Math.max(0, liquidLevel - rate * dt);
            }

            if (hasPouredAny && tilt < SETTLE_THRESHOLD) {
                uprightTimer += dt;
                if (uprightTimer >= SETTLE_TIME) {
                    endGame();
                    return;
                }
            } else {
                uprightTimer = 0;
            }

            render(isPouring);

            dom.hudTilt.textContent  = tilt.toFixed(0);
            dom.hudLevel.textContent = liquidLevel.toFixed(1);
            dom.debug.textContent =
                'mode: ' + sensorMode +
                ' | beta: ' + currentBeta.toFixed(1) +
                ' | init: ' + initialBeta.toFixed(1) +
                ' | raw: ' + rawTilt.toFixed(1) +
                ' | ev: ' + sensorEventCount +
                ' | tried: ' + triedApis.join(',');

            rafId = requestAnimationFrame(tick);
        }

        function endGame() {
            state = 'scored';
            if (rafId) { cancelAnimationFrame(rafId); rafId = null; }

            const diff     = Math.abs(liquidLevel - TARGET_LEVEL);
            const accuracy = Math.max(0, 100 - diff * 2.5);

            let title, sub;
            if (diff <= 0.5)       { title = 'Perfect Split!';   sub = 'Absolutely nailed it.'; }
            else if (diff <= 2)    { title = 'Incredible!';      sub = 'Surgeon-level precision.'; }
            else if (diff <= 5)    { title = 'Great Split!';     sub = 'Proper pub skills.'; }
            else if (diff <= 10)   { title = 'Good Effort';      sub = 'Getting there.'; }
            else if (diff <= 20)   { title = 'Not Bad';          sub = 'Room for improvement.'; }
            else if (liquidLevel > TARGET_LEVEL) {
                                     title = 'Drink More!';      sub = 'Didn\'t commit to the sip.'; }
            else                   { title = 'Too Greedy!';      sub = 'Left the G behind.'; }

            dom.scoreTitle.textContent = title;
            dom.scoreSub.textContent   = sub;
            dom.sLevel.textContent     = liquidLevel.toFixed(1) + '%';
            dom.sAccuracy.textContent  = accuracy.toFixed(0) + '%';

            dom.accFill.className = 'accuracy-fill ' +
                (accuracy >= 90 ? 'green' : accuracy >= 50 ? 'gold' : 'red');

            dom.miniLiquid.style.height = liquidLevel + '%';

            dom.accFill.style.width = '0%';
            showScreen('score');
            requestAnimationFrame(() => {
                dom.accFill.style.width = accuracy.toFixed(0) + '%';
            });
        }

        function resetGame() {
            state = 'idle';
            dom.btnStart.disabled = false;
            dom.btnStart.textContent = 'START';
            showScreen('start');
        }

        /* ════════════════════════════════════════════════════════
         * RENDERING
         * ════════════════════════════════════════════════════════ */

        function render(isPouring) {
            const px = (liquidLevel / 100) * GLASS_HEIGHT + LIQUID_BOTTOM_PAD;
            dom.liquid.style.height    = px + 'px';
            dom.liquid.style.transform = 'rotate(' + surfaceAngle.toFixed(2) + 'deg)';

            const foamH = FOAM_HEIGHT_MAX * clamp(liquidLevel / 25, 0, 1);
            dom.foam.style.height = foamH + 'px';

            if (isPouring) {
                dom.pourInd.classList.add('visible');
            } else {
                dom.pourInd.classList.remove('visible');
            }
        }

        /* ════════════════════════════════════════════════════════
         * SCREEN MANAGEMENT
         * ════════════════════════════════════════════════════════ */

        function showScreen(name) {
            for (const key in screens) {
                screens[key].classList.toggle('active', key === name);
            }
        }

        /* ════════════════════════════════════════════════════════
         * UTILITIES
         * ════════════════════════════════════════════════════════ */

        function clamp(v, lo, hi) { return Math.max(lo, Math.min(hi, v)); }
        function sleep(ms) { return new Promise((r) => setTimeout(r, ms)); }

        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    await navigator.wakeLock.request('screen');
                }
            } catch (_) {}
        }

        /* ════════════════════════════════════════════════════════
         * EVENT LISTENERS
         * ════════════════════════════════════════════════════════ */

        dom.btnStart.addEventListener('click', startGame);
        dom.btnStop.addEventListener('click', () => {
            if (state === 'playing') endGame();
        });
        dom.btnRetry.addEventListener('click', resetGame);

        document.addEventListener('touchmove', (e) => {
            if (state === 'playing' && sensorMode !== 'touch') e.preventDefault();
        }, { passive: false });

        document.addEventListener('dblclick', (e) => e.preventDefault());

    })();
    </script>
</body>
</html>
